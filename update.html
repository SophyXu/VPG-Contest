<!DOCTYPE html>
<meta charset="utf-8">
<html>
  <head>
    <style>
      rect.bordered {
        stroke: #E6E6E6;
        stroke-width:2px;   
      }
      text.mono {
        font-size: 9pt;
        font-family: Consolas, courier;
        fill: #aaa;
      }
      text.axis-workweek {
        fill: #000;
      }
      text.axis-worktime {
        fill: #000;
      } 

      .node rect {
        cursor: move;
        fill-opacity: .9;
        shape-rendering: crispEdges;
      }
       
      .node text {
        pointer-events: none;
        text-shadow: 0 1px 0 #fff;
      }
       
      .link {
        fill: none;
        stroke: #000;
        stroke-opacity: .2;
      }
       
      .link:hover {
        stroke-opacity: .5;
      }

      div.small{
        border: 0px solid #000;
        width: 700px;
        height: 900px;
        margin-top: 100px;
        float: left;
      }
      div.sankey{
        border: 0px solid #000;
        width: 200px;
        height: 900px;
        margin-top: 100px;
        float: left;
      }
    </style>
    <script src="http://d3js.org/d3.v3.js"></script>
    <script src="sankey.js"></script>
  </head>
  <body>
    <div >
      <div class="small" id="chart1"></div>
      <div class="sankey" id="chart4"></div>
      <div class="small" id="chart2"></div>
      <div class="sankey" id="chart5"></div>
      <div class="small" id="chart3"></div>
    </div>

    <script type="text/javascript">
      var margin = { top: 50, right: 0, bottom: 100, left: 30 },
          width = 700 - margin.left - margin.right,
          height = 900 - margin.top - margin.bottom,
          gridSize = Math.floor(width / 36),
          legendElementWidth = gridSize*2.56,
          buckets = 7,
          colors = ["#ffffd9","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#081d58"],
          // colors = ["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"],
          majors = ["Agr", "Arc", "Are", "Art", "Bus", "Com", "Com", "C&M", "Edu", "E&D", "Eng", "E&F", "H&A", "H&T", "Phi", "Rep", "Sci", "Soc"],
          majorss = ["Agric. & Nat. Res. Cons","Architecture","Area, Eth. & Multidiscip. Studies","Arts: Visual & Performing","Business","Commun, Fam., & Personal Svcs","Communications","Comp. Sci. & Mathematics","Education","Eng. Tech. & Drafting","Engineering","English & Foreign Lang.","Health Admin. & Assisting","Health Sci. & Techno.","Philosophy, Religion, & Theology","Repair, Production, & Construction","Sciences: Biological & Physical", "Social Sciences & Law"],
          matchs = ["Bus", "Edu", "Com", "H&T", "C&M", "H&A", "Art", "Rep", "Agr", "Soc", "Com", "E&F", "E&D", "Are", "Sci", "Eng", "Phi", "Arc"],
          range = [0, 0.05, 0.1, 0.15, 0.25, 0.35, 0.4];

          // number of people for a major
          var number_1 = new Array();
          var number_2 = new Array();
          var number_3 = new Array();

          // 2-d array
          var array_1 = new Array();
          var array_2 = new Array();
          var array_3 = new Array();
          var sum_1 = new Array();
          var sum_2 = new Array();
          var sum_3 = new Array();

          var SUM = 0;

          var max_1 = 0;
          var max_2 = 0;
          var max_3 = 0;

          // temp
          var transfer_12 = new Array();
          var transfer_23 = new Array();

          var numberScale_1 = 0;
          var numberScale_2 = 0;
          var numberScale_3 = 0;

          for(var i = 0; i < 18; ++i){
            array_1[i] = new Array();
            array_2[i] = new Array();
            array_3[i] = new Array();
            number_1[i] = 0;
            number_2[i] = 0;
            number_3[i] = 0;

            // temp
            transfer_12[i] = new Array();
            transfer_23[i] = new Array();

            for(var j = 0; j < 18; ++j){
              array_1[i][j] = 0;
              array_2[i][j] = 0;
              array_3[i][j] = 0;

              // temp
              transfer_12[i][j] = 0;
              transfer_23[i][j] = 0;
            }
          }

          d3.csv("student.csv", function(d) {
              var i = major2index(d.T1_Level2);
              var j = major2index(d.HighestLevel2);
              var ii = major2index(d.T2_Level2);
              var iii = major2index(d.T3_Level2);

              transfer_12[i][ii] += d.count/1;
              transfer_23[ii][iii] += d.count/1;
              
              array_1[i][j] += d.count/1;
              number_1[i] += d.count/1;

              i = major2index(d.T2_Level2);
              array_2[i][j] += d.count/1;
              number_2[i] += d.count/1;

              i = major2index(d.T3_Level2);
              array_3[i][j] += d.count/1;             
              number_3[i] += d.count/1; 

              SUM += d.count/1;

              return {
              };
            },
            function(error, data) {
              for(var i = 0; i < 18; ++i)
                for(var j = 0; j < 18; ++j) {
                  transfer_12[i][j] = transfer_12[i][j] / number_1[i];
                  transfer_23[i][j] = transfer_23[i][j] / number_2[i];
                }

              for(var j = 0; j < 18; ++j) {
                var sum = 0;
                for(var i = 0; i < 18; ++i) {
                  sum += array_1[i][j] / number_1[i];
                }
              }
              for(var i = 0; i < 18; ++i)
                for(var j = 0; j < 18; ++j) {
                  if(transfer_23[i][j] > 0.1 && (i != j))
                  console.log("{\"source\":\"" + majorss[i] + "\",\"target\":\"" + majorss[j] + "*\",\"value\":\"" + transfer_23[i][j] + "\"},");
                }
              for(var i = 0; i < 18; ++i)
                for(var j = 0; j < 18; ++j) {
                  sum_1[i*18+j] = array_1[i][j];

                  sum_2[i*18+j] = array_2[i][j];

                  if(array_3[i][j] > max_3)
                    max_3 = array_3[i][j];
                  sum_3[i*18+j] = array_3[i][j];
                }

              var test = new Array();
              // numberScale_1 = d3.scale.log().base(10).domain([d3.min(number_1), d3.max(number_1)]).range([height/7.5,0]);
              // console.log(numberScale_1);
              // numberScale_1 = d3.scale.linear().domain([d3.min(number_1), d3.max(number_1)]).range([10,129]);
              // numberScale_2 = d3.scale.log().base(10).domain([d3.min(number_2), d3.max(number_2)]).range([0,50]);
              // numberScale_3 = d3.scale.log().base(10).domain([d3.min(number_2), d3.max(number_2)]).range([10,50]);
              numberScale_1 = d3.scale.linear().domain([d3.min(number_1), d3.max(number_1)]).range([10,129]);
              numberScale_2 = d3.scale.linear().domain([d3.min(number_2), d3.max(number_2)]).range([10,89]);
              numberScale_3 = d3.scale.linear().domain([d3.min(number_3), d3.max(number_3)]).range([10,89]);

              var svg = d3.select("#chart1").append("svg")
                  .attr("width", width + margin.left + margin.right)
                  .attr("height", height + margin.top + margin.bottom)
                  .append("g")
                  .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
              var matchLabels = svg.selectAll(".matchLabel")
                  .data(matchs)
                  .enter().append("text")
                    .text(function (d, i) { return matchs[i]; })
                    .attr("x", 0)
                    .attr("y", function(d, i) {
                      var len = 0; 
                      for (var t = 0; t < (Math.floor(i%18)); ++t) {
                        len += numberScale_1(number_1[t]);
                      } 
                      len += 0.5 * numberScale_1(number_1[t]);
                      return (len-10); 
                    })
                    .style("text-anchor", "end")
                    .attr("transform", "translate(-6," + gridSize / 1.5 + ")")
                    .attr("class", function (d, i) { return ((i >= 0 && i <= 17) ? "matchLabel mono axis axis-workweek" : "matchLabel mono axis"); });
              // var majorLabels = svg.selectAll(".majorLabel")
              //     .data(majors)
              //     .enter().append("text")
              //       .text(function(d) { return d; })
              //       .attr("x", function(d, i) { return i * gridSize; })
              //       .attr("y", 0)
              //       .style("text-anchor", "middle")
              //       .attr("transform", "translate(" + gridSize / 2 + ", -6)")
              //       .attr("class", function(d, i) { return ((i >= 0 && i <= 17) ? "timeLabel mono axis axis-worktime" : "timeLabel mono axis"); });                    
              var heatMap = svg.selectAll(".hit")
                  .data(sum_1)
                  .enter().append("rect")
                  .attr("x", function(d, i) {
                    var len = 0;
                    for (var t = 0; t < (i%18); ++t) {
                      len += numberScale_1(number_1[t]);
                    }
                    return len; 
                  })
                  .attr("y", function(d, i) {
                    var len = 0;
                    for (var t = 0; t < (Math.floor(i/18)); ++t) {
                      len += numberScale_1(number_1[t]);
                    } 
                    return len; 
                  })
                  .attr("rx", 4)
                  .attr("ry", 4)
                  .attr("class", "hour bordered")
                  .attr("width", function(d, i) {return numberScale_1(number_1[i%18]); })
                  .attr("height", function(d, i) {return numberScale_1(number_1[Math.floor(i/18)]); })
                  .style("fill", colors[0]);
              heatMap.transition().duration(1000)
                  .style("fill", function(d, i) {
                  if(d/number_1[Math.floor(i/18)] == 0)
                    return colors[0]; 
                    for (var t = 1; t < range.length; ++t) {
                      if(d/number_1[Math.floor(i/18)] <= range[t])
                        return colors[t-1];
                    }
                    return colors[range.length - 1]; 
                  });
              heatMap.append("title").text(function(d, i) { return d/number_1[Math.floor(i/18)]; });

              var legend = svg.selectAll(".legend")
                  .data(range)
                  .enter().append("g")
                  .attr("class", "legend");
              legend.append("rect")
                .attr("x", function(d, i) { return legendElementWidth * i; })
                .attr("y", height + 10)
                .attr("width", legendElementWidth)
                .attr("height", gridSize / 2)
                .style("fill", function(d, i) { return colors[i]; });
              legend.append("text")
                .attr("class", "mono")
                .text(function(d) { return "≥ " + d; })
                .attr("x", function(d, i) { return legendElementWidth * i; })
                .attr("y", height + gridSize + 10);
              
          });
          d3.csv("student.csv", function(d) {
              return {
              };
            },
            function(error, data) {
                var svg = d3.select("#chart2").append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                var matchLabels = svg.selectAll(".matchLabel")
                    .data(matchs)
                    .enter().append("text")
                      .text(function (d, i) {
                       return matchs[i]; 
                     })
                      .attr("x", 0)
                      .attr("y", function(d, i) {
                        var len = 0;
                        for (var t = 0; t < (Math.floor(i%18)); ++t) {
                          len += numberScale_2(number_2[t]);
                        } 
                        len += 0.5 * numberScale_2(number_2[t]);
                        return (len-10); 
                      })
                      .style("text-anchor", "end")
                      .attr("transform", "translate(-6," + gridSize / 1.5 + ")")
                      .attr("class", function (d, i) { return ((i >= 0 && i <= 17) ? "matchLabel mono axis axis-workweek" : "matchLabel mono axis"); });
                // var majorLabels = svg.selectAll(".majorLabel")
                //     .data(majors)
                //     .enter().append("text")
                //       .text(function(d) { return d; })
                //       .attr("x", function(d, i) { return i * gridSize; })
                //       .attr("y", 0)
                //       .style("text-anchor", "middle")
                //       .attr("transform", "translate(" + gridSize / 2 + ", -6)")
                //       .attr("class", function(d, i) { return ((i >= 0 && i <= 17) ? "timeLabel mono axis axis-worktime" : "timeLabel mono axis"); });
                var heatMap = svg.selectAll(".hit")
                    .data(sum_2)
                    .enter().append("rect")
                    .attr("x", function(d, i) {
                      var len = 0;
                      for (var t = 0; t < (i%18); ++t) {
                        len += numberScale_2(number_2[t]);
                      }
                      return len; 
                    })
                    .attr("y", function(d, i) {
                      var len = 0;
                      for (var t = 0; t < (Math.floor(i/18)); ++t) {
                        len += numberScale_2(number_2[t]);
                      } 
                      return len; 
                    })
                    .attr("rx", 4)
                    .attr("ry", 4)
                    .attr("class", "hour bordered")
                    .attr("width", function(d, i) {return numberScale_2(number_2[i%18]); })
                    .attr("height", function(d, i) {return numberScale_2(number_2[Math.floor(i/18)]); })
                    .style("fill", colors[0]);
                heatMap.transition().duration(1000)
                    .style("fill", function(d, i) { 
                      for (var t = 1; t < range.length; ++t) {
                        if(d/number_2[Math.floor(i/18)] <= range[t])
                          return colors[t-1];
                      }
                      return colors[range.length - 1]; 
                    });
                heatMap.append("title").text(function(d, i) { return d/number_2[Math.floor(i/18)]; });

                // var legend = svg.selectAll(".legend")
                //     .data(range)
                //     .enter().append("g")
                //     .attr("class", "legend");
                // legend.append("rect")
                //   .attr("x", function(d, i) { return legendElementWidth * i; })
                //   .attr("y", height + 10)
                //   .attr("width", legendElementWidth)
                //   .attr("height", gridSize / 2)
                //   .style("fill", function(d, i) { return colors[i]; });
                // legend.append("text")
                //   .attr("class", "mono")
                //   .text(function(d) { return "≥ " + d; })
                //   .attr("x", function(d, i) { return legendElementWidth * i; })
                //   .attr("y", height + gridSize + 10);
          });
          d3.csv("student.csv", function(d) {
              return {
              };
            },
            function(error, data) {
                var svg = d3.select("#chart3").append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                var matchLabels = svg.selectAll(".matchLabel")
                    .data(matchs)
                    .enter().append("text")
                      .text(function (d) { return d; })
                      .attr("x", 0)
                      .attr("y", function(d, i) {
                        var len = 0;
                        for (var t = 0; t < (Math.floor(i%18)); ++t) {
                          len += numberScale_3(number_3[t]);
                        } 
                        len += 0.5 * numberScale_3(number_3[t]);
                        return (len-10); 
                      })
                      .style("text-anchor", "end")
                      .attr("transform", "translate(-6," + gridSize / 1.5 + ")")
                      .attr("class", function (d, i) { return ((i >= 0 && i <= 17) ? "matchLabel mono axis axis-workweek" : "matchLabel mono axis"); });
                // var majorLabels = svg.selectAll(".majorLabel")
                //     .data(majors)
                //     .enter().append("text")
                //       .text(function(d) { return d; })
                //       .attr("x", function(d, i) { return i * gridSize; })
                //       .attr("y", 0)
                //       .style("text-anchor", "middle")
                //       .attr("transform", "translate(" + gridSize / 2 + ", -6)")
                //       .attr("class", function(d, i) { return ((i >= 0 && i <= 17) ? "timeLabel mono axis axis-worktime" : "timeLabel mono axis"); });
                var heatMap = svg.selectAll(".hit")
                    .data(sum_3)
                    .enter().append("rect")
                    .attr("x", function(d, i) {
                      var len = 0;
                      for (var t = 0; t < (i%18); ++t) {
                        len += numberScale_3(number_3[t]);
                      }
                      return len; 
                    })
                    .attr("y", function(d, i) {
                      var len = 0;
                      for (var t = 0; t < (Math.floor(i/18)); ++t) {
                        len += numberScale_3(number_3[t]);
                      } 
                      return len; 
                    })
                    .attr("rx", 4)
                    .attr("ry", 4)
                    .attr("class", "hour bordered")
                    .attr("width", function(d, i) {return numberScale_3(number_3[i%18]); })
                    .attr("height", function(d, i) {return numberScale_3(number_3[Math.floor(i/18)]); })
                    .style("fill", colors[0]);
                heatMap.transition().duration(1000)
                    .style("fill", function(d, i) { 
                      for (var t = 1; t < range.length; ++t) {
                        if(d/number_3[Math.floor(i/18)] <= range[t])
                          return colors[t-1];
                      }
                      return colors[range.length - 1]; 
                    });
                heatMap.append("title").text(function(d, i) { return d/number_3[Math.floor(i/18)]; });

                // var legend = svg.selectAll(".legend")
                //     .data(range)
                //     .enter().append("g")
                //     .attr("class", "legend");
                // legend.append("rect")
                //   .attr("x", function(d, i) { return legendElementWidth * i; })
                //   .attr("y", height + 10)
                //   .attr("width", legendElementWidth)
                //   .attr("height", gridSize / 2)
                //   .style("fill", function(d, i) { return colors[i]; });
                // legend.append("text")
                //   .attr("class", "mono")
                //   .text(function(d) { return "≥ " + d; })
                //   .attr("x", function(d, i) { return legendElementWidth * i; })
                //   .attr("y", height + gridSize + 10);
              
          });
          function major2index(major) {
            var num = 0;
            // if(major == "Agric. & Nat. Res. Cons") num = 0;
            // if(major == "Architecture") num = 1;
            // if(major == "Area, Eth. & Multidiscip. Studies") num = 2;
            // if(major == "Arts: Visual & Performing") num = 3;
            // if(major == "Business") num = 4;
            // if(major == "Commun, Fam., & Personal Svcs") num = 5;
            // if(major == "Communications") num = 6;
            // if(major == "Comp. Sci. & Mathematics") num = 7;
            // if(major == "Education") num = 8;
            // if(major == "Eng. Tech. & Drafting") num = 9;
            // if(major == "Engineering") num = 10;
            // if(major == "English & Foreign Lang.") num = 11;
            // if(major == "Health Admin. & Assisting") num = 12;
            // if(major == "Health Sci. & Techno.") num = 13;
            // if(major == "Philosophy, Religion, & Theology") num = 14;
            // if(major == "Repair, Production, & Construction") num = 15;
            // if(major == "Sciences: Biological & Physical") num = 16;
            // if(major == "Social Sciences & Law") num = 17;

            if(major == "Agric. & Nat. Res. Cons") num = 8;
            if(major == "Architecture") num = 17;
            if(major == "Area, Eth. & Multidiscip. Studies") num = 13;
            if(major == "Arts: Visual & Performing") num = 6;
            if(major == "Business") num = 0;
            if(major == "Commun, Fam., & Personal Svcs") num = 2;
            if(major == "Communications") num = 10;
            if(major == "Comp. Sci. & Mathematics") num = 4;
            if(major == "Education") num = 1;
            if(major == "Eng. Tech. & Drafting") num = 12;
            if(major == "Engineering") num = 15;
            if(major == "English & Foreign Lang.") num = 11;
            if(major == "Health Admin. & Assisting") num = 5;
            if(major == "Health Sci. & Techno.") num = 3;
            if(major == "Philosophy, Religion, & Theology") num = 16;
            if(major == "Repair, Production, & Construction") num = 7;
            if(major == "Sciences: Biological & Physical") num = 14;
            if(major == "Social Sciences & Law") num = 9;
            return num;
          }

          sankeyGraph("#chart4", "raw.json");
          sankeyGraph("#chart5", "raw_2.json");

          function sankeyGraph(id, file) {
          // Sankey
          var units = "Widgets";
           
          var margin_sankey = {top: margin.top, right: 0, bottom: 10, left: 0},
              width_sankey = 200 - margin_sankey.left - margin_sankey.right + margin.left,
              height_sankey = 900 - margin_sankey.top - margin_sankey.bottom;
           
          var formatNumber = d3.format(",.0f"),
              format = function(d) { return formatNumber(d) + " " + units; },
              color = d3.scale.category20();
           
          // append the svg canvas to the page
          var svg = d3.select(id).append("svg")
              .attr("width", width_sankey + margin_sankey.left + margin_sankey.right)
              .attr("height", height_sankey + margin_sankey.top + margin_sankey.bottom)
            .append("g")
              .attr("transform", 
                    "translate(" + margin_sankey.left + "," + margin_sankey.top + ")");
           
          var sankey = d3.sankey()
              .nodeWidth(1)
              .nodePadding(0)
              .size([width_sankey, height_sankey]);
           
          var path = sankey.link();

          var linkWidth = new Array();

          // load the data
          d3.json(file, function(error, graph) {
           
              var nodeMap = {};
              graph.nodes.forEach(function(x) { nodeMap[x.name] = x;});
              graph.links = graph.links.map(function(x) {
                return {
                  source: nodeMap[x.source],
                  target: nodeMap[x.target],
                  value: x.value,
                };
              });
           
            sankey
                .nodes(graph.nodes)
                .links(graph.links)
                .layout(0);
           
          graph.links.forEach(function(link, i){
            link.dy = link.value*numberScale_1(number_1[major2index(link.source.name)]);
          });

          graph.nodes.forEach(function(node, i) {
              node.x = (i<18)?0:(width_sankey-1);
              var len = 0;
              if(i<18) {
                for (var t = 0; t < i; ++t)
                  len += numberScale_1(number_1[t]);
                // len += 1/2 * numberScale_1(number_1[t]);
              }
              else {
                for (var t = 0; t < i%18; ++t)
                  len += numberScale_2(number_2[t]);
                // len += 1/2 * numberScale_2(number_2[t]);
              }
              node.y = len;
          });

          sankey.relayout();

          // Link height
          var link = svg.append("g").selectAll(".link")
              .data(graph.links)
            .enter().append("path")
              .attr("class", "link")
              .attr("d", path)
              .style("stroke-width", function(d, i) { 
                  return d.dy;
              })
              .sort(function(a, b) { return b.dy - a.dy; });

          // add in the nodes
          var node = svg.append("g").selectAll(".node")
              .data(graph.nodes)
            .enter().append("g")
              .attr("class", "node")
              .attr("transform", function(d) { 
              return "translate(" + d.x + "," + d.y + ")"; })
            .call(d3.behavior.drag()
              .origin(function(d) { return d; })
              .on("dragstart", function() { 
              this.parentNode.appendChild(this); })
              .on("drag", dragmove));

          sankey.relayout();
           
          // Node height
          node.append("rect")
              .attr("height", function(d, i) { 
                if(i < 18) {
                  return numberScale_1(number_1[i]);
                }
                else {
                  i = i - 18;
                  return numberScale_2(number_2[i]);
                }
              })
              .attr("width", sankey.nodeWidth())
              .style("fill", "#fff")
              .style("stroke", "#fff")
            .append("title")
              .text(function(d) { 
              return d.name + "\n" + format(d.value); });

          sankey.relayout();

          // the function for moving the nodes
          function dragmove(d) {
            d3.select(this).attr("transform", 
                "translate(" + (
                     d.x = Math.max(0, Math.min(width_sankey - d.dx, d3.event.x))
                  ) + "," + (
                           d.y = Math.max(0, Math.min(height_sankey - d.dy, d3.event.y))
                    ) + ")");
            sankey.relayout();
            link.attr("d", path);
          }
        });
}
    </script>
  </body>
</html>